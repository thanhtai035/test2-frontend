{"version":3,"file":"AuthTransaction.js","names":["AuthTransaction","constructor","sdk","res","data","undefined","status","interactionHandle","flattenEmbedded","stateToken","_links","cancel","resolve","tx","createTransaction","link2fn","obj","link","ref","Array","isArray","name","opts","AuthSdkError","lk","hints","allow","length","method","href","withCredentials","isPolling","factorType","provider","params","autoPush","e","reject","rememberDevice","profile","updatePhone","links2fns","fns","linkName","Object","prototype","hasOwnProperty","call","type","poll","fn","objArr","o","ol","push","embedded","_embedded","key"],"sources":["../../../lib/tx/AuthTransaction.ts"],"sourcesContent":["/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n *\n */\n\nimport { get } from '../http';\nimport { find, omit, toQueryString, clone, isObject } from '../util';\nimport AuthSdkError from '../errors/AuthSdkError';\nimport { TransactionState } from './TransactionState';\nimport { addStateToken } from './util';\nimport { getPollFn } from './poll';\nimport { postToTransaction } from './api';\nimport { IdxStatus } from '../idx/types';\n\ninterface PostToTransactionParams {\n  autoPush?: boolean;\n  rememberDevice?: boolean;\n  updatePhone?: boolean;\n}\n\n// eslint-disable-next-line no-use-before-define\ntype AuthTransactionFunction = (obj?: any) => Promise<AuthTransaction>;\n\ninterface AuthTransactionFunctions {\n  // common\n  next?: AuthTransactionFunction;\n  cancel?: AuthTransactionFunction;\n  skip?: AuthTransactionFunction;\n  // locked_out\n  unlock?: AuthTransactionFunction;\n  // password\n  changePassword?: AuthTransactionFunction;\n  resetPassword?: AuthTransactionFunction;\n  // recovery\n  answer?: AuthTransactionFunction;\n  recovery?: AuthTransactionFunction;\n  // recovery_challenge\n  verify?: AuthTransactionFunction;\n  resend?: AuthTransactionFunction;\n  // mfa_enroll_activate\n  activate?: AuthTransactionFunction;\n  poll?: AuthTransactionFunction;\n  prev?: AuthTransactionFunction;\n}\n\nexport class AuthTransaction implements TransactionState, AuthTransactionFunctions {\n  next?: AuthTransactionFunction;\n  cancel?: AuthTransactionFunction;\n  skip?: AuthTransactionFunction;\n  unlock?: AuthTransactionFunction;\n  changePassword?: AuthTransactionFunction;\n  resetPassword?: AuthTransactionFunction;\n  answer?: AuthTransactionFunction;\n  recovery?: AuthTransactionFunction;\n  verify?: AuthTransactionFunction;\n  resend?: AuthTransactionFunction;\n  activate?: AuthTransactionFunction;\n  poll?: AuthTransactionFunction;\n  prev?: AuthTransactionFunction;\n\n  data?: TransactionState;\n  stateToken?: string;\n  sessionToken?: string;\n  status: string | IdxStatus;\n  user?: Record<string, any>;\n  factor?: Record<string, any>;\n  factors?: Array<Record<string, any> >;\n  policy?: Record<string, any>;\n  scopes?: Array<Record<string, any> >;\n  target?: Record<string, any>;\n  authentication?: Record<string, any>;\n  constructor(sdk, res: TransactionState | null = null) {\n    this.data = undefined;\n    this.status = undefined as unknown as string;\n    if (res) {\n      this.data = res;\n\n      if (this.data.interactionHandle) {\n        this.status = res.status;\n        return;\n      }\n\n      // Parse response from Authn V1\n      Object.assign(this, flattenEmbedded(sdk, res, res, {}));\n      delete this.stateToken;\n\n      // RECOVERY_CHALLENGE has some responses without _links.\n      // Without _links, we emulate cancel to make it intuitive\n      // to return to the starting state. We may remove this\n      // when OKTA-75434 is resolved\n      if (res.status === 'RECOVERY_CHALLENGE' && !res._links) {\n        this.cancel = function() {\n          return Promise.resolve(sdk.tx.createTransaction());\n        };\n      }\n    }\n  }\n}\n\nfunction link2fn(sdk, res, obj, link, ref) {\n  if (Array.isArray(link)) {\n    return function(name, opts?) {\n      if (!name) {\n        throw new AuthSdkError('Must provide a link name');\n      }\n\n      var lk = find(link, {name: name});\n      if (!lk) {\n        throw new AuthSdkError('No link found for that name');\n      }\n\n      return link2fn(sdk, res, obj, lk, ref)(opts);\n    };\n\n  } else if (link.hints &&\n      link.hints.allow &&\n      link.hints.allow.length === 1) {\n    var method = link.hints.allow[0];\n    switch (method) {\n\n      case 'GET':\n        return function() {\n          return get(sdk, link.href, { withCredentials: true });\n        };\n\n      case 'POST':\n        // eslint-disable-next-line max-statements,complexity\n        return function(opts: TransactionState) {\n          if (ref && ref.isPolling) {\n            ref.isPolling = false;\n          }\n\n          var data = addStateToken(res, opts);\n\n          if (res.status === 'MFA_ENROLL' || res.status === 'FACTOR_ENROLL') {\n            // Add factorType and provider\n            Object.assign(data, {\n              factorType: obj.factorType,\n              provider: obj.provider\n            });\n          }\n\n          var params = {} as PostToTransactionParams;\n          var autoPush = data.autoPush;\n          if (autoPush !== undefined) {\n            if (typeof autoPush === 'function') {\n              try {\n                params.autoPush = !!autoPush();\n              }\n              catch (e) {\n                return Promise.reject(new AuthSdkError('AutoPush resulted in an error.'));\n              }\n            }\n            else if (autoPush !== null) {\n              params.autoPush = !!autoPush;\n            }\n            data = omit(data, 'autoPush');\n          }\n\n          var rememberDevice = data.rememberDevice;\n          if (rememberDevice !== undefined) {\n            if (typeof rememberDevice === 'function') {\n              try {\n                params.rememberDevice = !!rememberDevice();\n              }\n              catch (e) {\n                return Promise.reject(new AuthSdkError('RememberDevice resulted in an error.'));\n              }\n            }\n            else if (rememberDevice !== null) {\n              params.rememberDevice = !!rememberDevice;\n            }\n            data = omit(data, 'rememberDevice');\n\n          } else if (data.profile &&\n                    data.profile.updatePhone !== undefined) {\n            if (data.profile.updatePhone) {\n              params.updatePhone = true;\n            }\n            data.profile = omit(data.profile, 'updatePhone');\n          }\n          var href = link.href + toQueryString(params);\n          return postToTransaction(sdk, href, data);\n        };\n    }\n  }\n}\n\nfunction links2fns(sdk, res, obj, ref) {\n  var fns = {} as AuthTransactionFunctions;\n  for (var linkName in obj._links) {\n    if (!Object.prototype.hasOwnProperty.call(obj._links, linkName)) {\n      continue;\n    }\n\n    var link = obj._links[linkName];\n    \n    if (linkName === 'next') {\n      linkName = link.name;\n    }\n\n    if (link.type) {\n      fns[linkName] = link;\n      continue;\n    }\n\n    switch (linkName) {\n      // poll is only found at the transaction\n      // level, so we don't need to pass the link\n      case 'poll':\n        fns.poll = getPollFn(sdk, res, ref);\n        break;\n\n      default:\n        var fn = link2fn(sdk, res, obj, link, ref);\n        if (fn) {\n          fns[linkName] = fn;\n        }\n    }\n  }\n  return fns;\n}\n\n// eslint-disable-next-line complexity\nfunction flattenEmbedded(sdk, res, obj, ref) {\n  obj = obj || res;\n  obj = clone(obj);\n\n  if (Array.isArray(obj)) {\n    var objArr = [];\n    for (var o = 0, ol = obj.length; o < ol; o++) {\n      objArr.push(flattenEmbedded(sdk, res, obj[o], ref) as never);\n    }\n    return objArr;\n  }\n\n  var embedded = obj._embedded || {};\n\n  for (var key in embedded) {\n    if (!Object.prototype.hasOwnProperty.call(embedded, key)) {\n      continue;\n    }\n\n    // Flatten any nested _embedded objects\n    if (isObject(embedded[key]) || Array.isArray(embedded[key])) {\n      embedded[key] = flattenEmbedded(sdk, res, embedded[key], ref);\n    }\n  }\n\n  // Convert any links on the embedded object\n  var fns = links2fns(sdk, res, obj, ref);\n  Object.assign(embedded, fns);\n\n  obj = omit(obj, '_embedded', '_links');\n  Object.assign(obj, embedded);\n  return obj;\n}\n"],"mappings":"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"}